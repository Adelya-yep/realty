{% extends 'realty/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h1 class="text-center mb-4">{% if edit %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ{% endif %} –æ–±—ä–µ–∫—Ç–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h1>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% if form.errors %}
                    <div class="alert alert-danger">
                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ
                    </div>
                    {% endif %}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ *</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="text-danger">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–¶–µ–Ω–∞ (—Ä—É–±) *</label>
                            {{ form.price }}
                            {% if form.price.errors %}
                            <div class="text-danger">{{ form.price.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ *</label>
                            {{ form.property_type }}
                            {% if form.property_type.errors %}
                            <div class="text-danger">{{ form.property_type.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–ü–ª–æ—â–∞–¥—å (–∫–≤.–º) *</label>
                            {{ form.area }}
                            {% if form.area.errors %}
                            <div class="text-danger">{{ form.area.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                            {{ form.rooms }}
                            {% if form.rooms.errors %}
                            <div class="text-danger">{{ form.rooms.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–∞–¥—Ä–µ—Å) *</label>
                        {{ form.location }}
                        {% if form.location.errors %}
                            <div class="text-danger">{{ form.location.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <div class="text-danger">{{ form.status.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
                    <div class="form-group">
                        <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>

                        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤ -->
                        <input type="file" name="images" id="id_images" multiple accept="image/*" style="display: none;">

                        <!-- –ö—Ä–∞—Å–∏–≤–∞—è –∑–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                        <div class="upload-zone" id="upload-zone">
                            <div class="upload-content">
                                <div class="upload-icon">üì∑</div>
                                <h4>–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h4>
                                <p class="text-muted">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('id_images').click()">
                                    –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                                </button>
                            </div>
                        </div>

                        <!-- –ü—Ä–µview –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
                        <div id="selected-files" class="mt-3"></div>

                        <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏) -->
                        {% if edit and property.images.all %}
                        <div class="existing-images mt-4">
                            <h5>–¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h5>
                            <div class="existing-images-grid">
                                {% for image in property.images.all %}
                                <div class="existing-image-item">
                                    <img src="{{ image.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {{ forloop.counter }}">
                                    <div class="image-actions">
                                        <button type="button" class="btn btn-sm btn-danger"
                                                onclick="deleteImage({{ image.id }})">–£–¥–∞–ª–∏—Ç—å</button>
                                        {% if not image.is_main %}
                                        <button type="button" class="btn btn-sm btn-primary"
                                                onclick="setAsMain({{ image.id }})">–°–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π</button>
                                        {% else %}
                                        <span class="badge bg-success">–û—Å–Ω–æ–≤–Ω–æ–µ</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <small class="text-muted">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤. –ü–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º.</small>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            {% if edit %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç{% endif %}
                        </button>
                        <a href="{% if edit %}{% url 'property_detail' property.pk %}{% else %}{% url 'property_list' %}{% endif %}"
                           class="btn btn-secondary">
                            –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-zone:hover {
    border-color: #3498db;
    background: #e3f2fd;
}

.upload-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #6c757d;
}

.upload-zone:hover .upload-icon {
    color: #3498db;
}

.upload-content h4 {
    color: #495057;
    margin-bottom: 0.5rem;
}

.upload-content p {
    margin-bottom: 1.5rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–æ–≤ */
.upload-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.preview-item {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    text-align: center;
    transition: border-color 0.3s ease;
    position: relative;
}

.preview-item:hover {
    border-color: #3498db;
}

.preview-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.preview-info {
    padding: 0.5rem;
    background: #f8f9fa;
    font-size: 0.8rem;
    color: #6c757d;
}

.main-badge {
    position: absolute;
    top: 5px;
    left: 5px;
    background: #28a745;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: bold;
}

.file-info {
    margin-top: 1rem;
    padding: 0.5rem;
    background: #e7f3ff;
    border-radius: 4px;
    font-size: 0.9rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
.existing-images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.existing-image-item {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    text-align: center;
}

.existing-image-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.image-actions {
    padding: 0.5rem;
    background: #f8f9fa;
}

.image-actions .btn {
    margin: 0.1rem;
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
}
</style>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
function showSelectedFiles(input) {
    const filesContainer = document.getElementById('selected-files');
    filesContainer.innerHTML = '';

    if (input.files.length > 0) {
        const previewContainer = document.createElement('div');
        previewContainer.className = 'upload-preview';

        let imagesLoaded = 0;
        const totalImages = Array.from(input.files).filter(file => file.type.startsWith('image/')).length;

        for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;

                    const fileName = document.createElement('div');
                    fileName.className = 'preview-info';
                    fileName.textContent = file.name.length > 20 ?
                        file.name.substring(0, 17) + '...' : file.name;

                    // –ü–æ–º–µ—Ç–∫–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    if (i === 0) {
                        const mainBadge = document.createElement('div');
                        mainBadge.className = 'main-badge';
                        mainBadge.textContent = '–û—Å–Ω–æ–≤–Ω–æ–µ';
                        previewItem.appendChild(mainBadge);
                    }

                    previewItem.appendChild(img);
                    previewItem.appendChild(fileName);
                    previewContainer.appendChild(previewItem);

                    imagesLoaded++;

                    if (imagesLoaded === totalImages) {
                        filesContainer.appendChild(previewContainer);

                        const info = document.createElement('div');
                        info.className = 'file-info';
                        info.innerHTML = `<strong>–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${input.files.length}</strong>. –ü–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ.`;
                        filesContainer.appendChild(info);
                    }
                };

                reader.readAsDataURL(file);
            }
        }
    } else {
        filesContainer.innerHTML = '<div class="text-muted text-center py-3">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
function deleteImage(imageId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?')) {
        fetch(`/property/image/${imageId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

function setAsMain(imageId) {
    fetch(`/property/image/${imageId}/set_main/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    }).then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_images');
    const uploadZone = document.getElementById('upload-zone');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
    fileInput.addEventListener('change', function() {
        showSelectedFiles(this);
    });

    // Drag and drop
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.style.borderColor = '#3498db';
        uploadZone.style.background = '#bbdefb';
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.style.borderColor = '#dee2e6';
        uploadZone.style.background = '#f8f9fa';
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.style.borderColor = '#dee2e6';
        uploadZone.style.background = '#f8f9fa';

        fileInput.files = e.dataTransfer.files;
        showSelectedFiles(fileInput);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–≤—å—é
    document.getElementById('selected-files').innerHTML = '<div class="text-muted text-center py-3">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
});
</script>
{% endblock %}