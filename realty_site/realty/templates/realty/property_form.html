{% extends 'realty/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h1 class="text-center mb-4">{% if edit %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ{% endif %} –æ–±—ä–µ–∫—Ç–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h1>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% if form.errors %}
                    <div class="alert alert-danger">
                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ
                    </div>
                    {% endif %}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ *</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="text-danger">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–¶–µ–Ω–∞ (—Ä—É–±) *</label>
                            {{ form.price }}
                            {% if form.price.errors %}
                            <div class="text-danger">{{ form.price.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ *</label>
                            {{ form.property_type }}
                            {% if form.property_type.errors %}
                            <div class="text-danger">{{ form.property_type.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–ü–ª–æ—â–∞–¥—å (–∫–≤.–º) *</label>
                            {{ form.area }}
                            {% if form.area.errors %}
                            <div class="text-danger">{{ form.area.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                            {{ form.rooms }}
                            {% if form.rooms.errors %}
                            <div class="text-danger">{{ form.rooms.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–∞–¥—Ä–µ—Å) *</label>
                        {{ form.location }}
                        {% if form.location.errors %}
                            <div class="text-danger">{{ form.location.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å *</label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <div class="text-danger">{{ form.status.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- –ö–†–ê–°–ò–í–ê–Ø –ó–û–ù–ê –ó–ê–ì–†–£–ó–ö–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô -->
                    <div class="mb-4">
                        <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>

                        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤ -->
                        <input type="file" name="images" multiple accept="image/*" id="image-input" style="display: none;">

                        <!-- –ö—Ä–∞—Å–∏–≤–∞—è –∑–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                        <div class="upload-zone" id="upload-zone">
                            <div class="upload-content">
                                <div class="upload-icon">üì∑</div>
                                <h4>–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h4>
                                <p class="text-muted">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('image-input').click()">
                                    –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                                </button>
                            </div>
                        </div>

                        <!-- –ü—Ä–µview –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
                        <div id="file-preview" class="mt-3"></div>

                        <small class="text-muted">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤. –ü–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB –Ω–∞ —Ñ–∞–π–ª.</small>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            {% if edit %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç{% endif %}
                        </button>
                        <a href="{% if edit %}{% url 'property_detail' property.pk %}{% else %}{% url 'property_list' %}{% endif %}"
                           class="btn btn-secondary">
                            –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.upload-zone:hover {
    border-color: #3498db;
    background: #e3f2fd;
}

.upload-zone.dragover {
    border-color: #3498db;
    background: #bbdefb;
    transform: scale(1.02);
}

.upload-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #6c757d;
}

.upload-zone:hover .upload-icon {
    color: #3498db;
}

.upload-content h4 {
    color: #495057;
    margin-bottom: 0.5rem;
}

.upload-content p {
    margin-bottom: 1.5rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–æ–≤ */
.file-preview-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.file-preview-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.file-preview-image {
    width: 100%;
    height: 100px;
    object-fit: cover;
    display: block;
}

.file-preview-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.file-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
}

.file-remove:hover {
    background: white;
    transform: scale(1.1);
}

.empty-preview {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('image-input');
    const filePreview = document.getElementById('file-preview');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∑–æ–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
    uploadZone.addEventListener('click', function(e) {
        if (!e.target.closest('.file-remove')) {
            fileInput.click();
        }
    });

    // Drag and drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            updateFilePreview();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ input
    fileInput.addEventListener('change', function() {
        updateFilePreview();
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–æ–≤
    function updateFilePreview() {
        const files = fileInput.files;
        filePreview.innerHTML = '';

        if (files.length === 0) {
            filePreview.innerHTML = '<div class="empty-preview">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
            return;
        }

        const container = document.createElement('div');
        container.className = 'file-preview-container';

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const item = document.createElement('div');
            item.className = 'file-preview-item';

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'file-preview-image';
                    img.alt = file.name;

                    const info = document.createElement('div');
                    info.className = 'file-preview-info';
                    info.textContent = file.name.length > 15 ?
                        file.name.substring(0, 12) + '...' : file.name;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'file-remove';
                    removeBtn.innerHTML = '√ó';
                    removeBtn.onclick = function(e) {
                        e.stopPropagation();
                        removeFile(i);
                    };

                    item.appendChild(img);
                    item.appendChild(info);
                    item.appendChild(removeBtn);
                };
                reader.readAsDataURL(file);
            } else {
                item.innerHTML = `
                    <div style="height: 100px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                        <span>üìÑ</span>
                    </div>
                    <div class="file-preview-info">${file.name}</div>
                    <button class="file-remove" onclick="removeFile(${i})">√ó</button>
                `;
            }

            container.appendChild(item);
        }

        filePreview.appendChild(container);
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    function removeFile(index) {
        const files = Array.from(fileInput.files);
        files.splice(index, 1);

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π FileList
        const dataTransfer = new DataTransfer();
        files.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;

        updateFilePreview();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–≤—å—é
    updateFilePreview();
});
</script>
{% endblock %}