{% extends 'realty/base.html' %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <h1>Регистрация</h1>

    <form id="register-form">
        {% csrf_token %}

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="id_username">Логин *</label>
                <input type="text" name="username" id="id_username" class="form-control" required>
                <small class="error" id="username-error" style="color: red; display: block;"></small>
            </div>

            <div class="form-group">
                <label for="id_email">Email *</label>
                <input type="email" name="email" id="id_email" class="form-control" required>
                <small class="error" id="email-error" style="color: red; display: block;"></small>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="id_first_name">Имя *</label>
                <input type="text" name="first_name" id="id_first_name" class="form-control" required>
                <small class="error" id="first_name-error" style="color: red; display: block;"></small>
            </div>

            <div class="form-group">
                <label for="id_last_name">Фамилия *</label>
                <input type="text" name="last_name" id="id_last_name" class="form-control" required>
                <small class="error" id="last_name-error" style="color: red; display: block;"></small>
            </div>
        </div>

        <div class="form-group">
            <label for="id_user_type">Тип пользователя *</label>
            <select name="user_type" id="id_user_type" class="form-control" required>
                <option value="">Выберите тип пользователя</option>
                <option value="realtor">Риэлтор</option>
                <option value="client">Клиент</option>
            </select>
            <small class="error" id="user_type-error" style="color: red; display: block;"></small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="id_phone">Телефон</label>
                <input type="text" name="phone" id="id_phone" class="form-control">
                <small class="error" id="phone-error" style="color: red; display: block;"></small>
            </div>

            <div class="form-group">
                <label for="id_gender">Пол</label>
                <select name="gender" id="id_gender" class="form-control">
                    <option value="">Не указано</option>
                    <option value="M">Мужской</option>
                    <option value="F">Женский</option>
                </select>
                <small class="error" id="gender-error" style="color: red; display: block;"></small>
            </div>
        </div>

        <div class="form-group">
            <label for="id_bio">О себе</label>
            <textarea name="bio" id="id_bio" class="form-control" rows="4"></textarea>
            <small class="error" id="bio-error" style="color: red; display: block;"></small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="id_password1">Пароль *</label>
                <input type="password" name="password1" id="id_password1" class="form-control" required>
                <small style="color: #666; display: block;">
                    Пароль должен содержать не менее 5 символов, включая буквы и цифры
                </small>
                <small class="error" id="password1-error" style="color: red; display: block;"></small>
            </div>

            <div class="form-group">
                <label for="id_password2">Подтверждение пароля *</label>
                <input type="password" name="password2" id="id_password2" class="form-control" required>
                <small class="error" id="password2-error" style="color: red; display: block;"></small>
            </div>
        </div>

        <!-- CAPTCHA -->
        <div class="form-group">
            <label for="id_captcha">Введите код с картинки *</label>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="captcha-text" style="font-family: monospace; font-size: 1.5rem; font-weight: bold;
                    background: #f0f0f0; padding: 0.5rem 1rem; border-radius: 4px; letter-spacing: 2px;">
                    {{ captcha_text }}
                </div>
                <input type="text" name="captcha" id="id_captcha" class="form-control" style="flex: 1;" required>
            </div>
            <small class="error" id="captcha-error" style="color: red; display: block;"></small>
        </div>

        <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;">Зарегистрироваться</button>
    </form>

    <div id="register-message" style="margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none;"></div>

    <div style="text-align: center; margin-top: 2rem;">
        <p>Уже есть аккаунт? <a href="{% url 'login' %}">Войдите в систему</a></p>
    </div>
</div>

<script>
$(document).ready(function() {
    // Функция для очистки ошибок
    function clearErrors() {
        $('.error').text('');
        $('#register-message').hide().removeClass('alert-success alert-danger');
    }

    // Функция для отображения ошибок
    function showErrors(errors) {
        for (var field in errors) {
            var errorField = $('#' + field + '-error');
            if (errorField.length) {
                errorField.text(errors[field][0].message);
            }
        }
    }

    // Обработка отправки формы
    $('#register-form').on('submit', function(e) {
        e.preventDefault();

        clearErrors();

        // Показываем загрузку
        var submitBtn = $(this).find('button[type="submit"]');
        var originalText = submitBtn.text();
        submitBtn.text('Регистрация...').prop('disabled', true);

        $.ajax({
            type: 'POST',
            url: '{% url "register" %}',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    $('#register-message')
                        .text('Регистрация успешна! Перенаправление на главную страницу...')
                        .addClass('alert-success')
                        .show();

                    setTimeout(function() {
                        window.location.href = '{% url "home" %}';
                    }, 1500);
                } else {
                    showErrors(response.errors);
                    $('#register-message')
                        .text('Пожалуйста, исправьте ошибки в форме')
                        .addClass('alert-danger')
                        .show();
                }
            },
            error: function(xhr, status, error) {
                $('#register-message')
                    .text('Произошла ошибка при регистрации. Пожалуйста, попробуйте еще раз.')
                    .addClass('alert-danger')
                    .show();
            },
            complete: function() {
                submitBtn.text(originalText).prop('disabled', false);
            }
        });
    });

    // Валидация в реальном времени
    $('#id_username').on('blur', function() {
        var username = $(this).val();
        if (username.length > 0) {
            $.ajax({
                type: 'GET',
                url: '{% url "register" %}',
                data: {
                    'check_username': username
                },
                success: function(response) {
                    if (response.exists) {
                        $('#username-error').text('Этот логин уже занят');
                    }
                }
            });
        }
    });

    $('#id_email').on('blur', function() {
        var email = $(this).val();
        if (email.length > 0) {
            $.ajax({
                type: 'GET',
                url: '{% url "register" %}',
                data: {
                    'check_email': email
                },
                success: function(response) {
                    if (response.exists) {
                        $('#email-error').text('Этот email уже используется');
                    }
                }
            });
        }
    });

    // Обновление CAPTCHA
    function refreshCaptcha() {
        $.ajax({
            type: 'GET',
            url: '{% url "register" %}',
            data: {
                'refresh_captcha': true
            },
            success: function(response) {
                if (response.captcha_text) {
                    $('#captcha-text').text(response.captcha_text);
                    $('#id_captcha').val('');
                }
            }
        });
    }

    // Кнопка обновления CAPTCHA (можно добавить иконку обновления)
    $('#captcha-text').css('cursor', 'pointer').on('click', function() {
        refreshCaptcha();
    });

    // Очистка ошибок при вводе
    $('input, select, textarea').on('input', function() {
        var fieldName = $(this).attr('name');
        $('#' + fieldName + '-error').text('');
    });
});
</script>

<style>
.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.form-control {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.75rem;
    font-size: 1rem;
}

.form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
}

.btn:hover {
    background: #2980b9;
}

.btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
}
</style>
{% endblock %}