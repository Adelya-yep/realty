{% extends 'realty/base.html' %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>

    <form id="register-form">
        {% csrf_token %}

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="id_username">–õ–æ–≥–∏–Ω *</label>
                <input type="text" name="username" id="id_username" class="form-control" required>
                <small class="error" id="username-error" style="color: red; display: block;"></small>
            </div>

            <div class="form-group">
                <label for="id_email">Email *</label>
                <input type="email" name="email" id="id_email" class="form-control" required>
                <small class="error" id="email-error" style="color: red; display: block;"></small>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="id_first_name">–ò–º—è *</label>
                <input type="text" name="first_name" id="id_first_name" class="form-control" required>
                <small class="error" id="first_name-error" style="color: red; display: block;"></small>
            </div>

            <div class="form-group">
                <label for="id_last_name">–§–∞–º–∏–ª–∏—è *</label>
                <input type="text" name="last_name" id="id_last_name" class="form-control" required>
                <small class="error" id="last_name-error" style="color: red; display: block;"></small>
            </div>
        </div>

        <div class="form-group">
            <label for="id_user_type">–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
            <select name="user_type" id="id_user_type" class="form-control" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                <option value="realtor">–†–∏—ç–ª—Ç–æ—Ä</option>
                <option value="client">–ö–ª–∏–µ–Ω—Ç</option>
            </select>
            <small class="error" id="user_type-error" style="color: red; display: block;"></small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="id_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="text" name="phone" id="id_phone" class="form-control">
                <small class="error" id="phone-error" style="color: red; display: block;"></small>
            </div>

            <div class="form-group">
                <label for="id_gender">–ü–æ–ª</label>
                <select name="gender" id="id_gender" class="form-control">
                    <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>
                    <option value="M">–ú—É–∂—Å–∫–æ–π</option>
                    <option value="F">–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>
                <small class="error" id="gender-error" style="color: red; display: block;"></small>
            </div>
        </div>

        <div class="form-group">
            <label for="id_bio">–û —Å–µ–±–µ</label>
            <textarea name="bio" id="id_bio" class="form-control" rows="4"></textarea>
            <small class="error" id="bio-error" style="color: red; display: block;"></small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="id_password1">–ü–∞—Ä–æ–ª—å *</label>
                <input type="password" name="password1" id="id_password1" class="form-control" required>
                <small style="color: #666; display: block;">
                    –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤, –≤–∫–ª—é—á–∞—è –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã
                </small>
                <small class="error" id="password1-error" style="color: red; display: block;"></small>
            </div>

            <div class="form-group">
                <label for="id_password2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è *</label>
                <input type="password" name="password2" id="id_password2" class="form-control" required>
                <small class="error" id="password2-error" style="color: red; display: block;"></small>
            </div>
        </div>

        <!-- CAPTCHA -->
        <div class="form-group">
            <label for="id_captcha">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏ *</label>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="captcha-text" style="font-family: monospace; font-size: 1.5rem; font-weight: bold;
                    background: #f0f0f0; padding: 0.5rem 1rem; border-radius: 4px; letter-spacing: 2px;
                    border: 2px solid #ccc; min-width: 120px; text-align: center; cursor: pointer;"
                    title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞">
                    {{ captcha_text }}
                </div>
                <input type="text" name="captcha" id="id_captcha" class="form-control" style="flex: 1;" required>
            </div>
            <small class="error" id="captcha-error" style="color: red; display: block;"></small>
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–æ–¥, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å
            </div>
        </div>

        <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </form>

    <div id="register-message" style="margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none;"></div>

    <div style="text-align: center; margin-top: 2rem;">
        <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É</a></p>
    </div>
</div>

<script>
$(document).ready(function() {
    console.log('üîç –û—Ç–ª–∞–¥–∫–∞: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    console.log('CAPTCHA —ç–ª–µ–º–µ–Ω—Ç:', $('#captcha-text').text());

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –æ—à–∏–±–æ–∫
    function clearErrors() {
        $('.error').text('');
        $('#register-message').hide().removeClass('alert-success alert-danger');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫
    function showErrors(errors) {
        console.log('–û—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã:', errors);
        for (var field in errors) {
            var errorField = $('#' + field + '-error');
            if (errorField.length) {
                errorField.text(errors[field][0].message);
            } else {
                console.log('–ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—à–∏–±–∫–∏:', field);
            }
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    $('#register-form').on('submit', function(e) {
        e.preventDefault();
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã');

        clearErrors();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        var submitBtn = $(this).find('button[type="submit"]');
        var originalText = submitBtn.text();
        submitBtn.text('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...').prop('disabled', true);

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        var formData = $(this).serialize();
        console.log('–î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', formData);

        $.ajax({
            type: 'POST',
            url: '{% url "register" %}',
            data: formData,
            success: function(response) {
                console.log('‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
                if (response.success) {
                    $('#register-message')
                        .text('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É...')
                        .addClass('alert-success')
                        .show();

                    setTimeout(function() {
                        window.location.href = '{% url "home" %}';
                    }, 1500);
                } else {
                    showErrors(response.errors);
                    $('#register-message')
                        .text('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ')
                        .addClass('alert-danger')
                        .show();
                }
            },
            error: function(xhr, status, error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ AJAX:', error);
                console.log('–°—Ç–∞—Ç—É—Å:', status);
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', xhr.responseText);
                $('#register-message')
                    .text('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.')
                    .addClass('alert-danger')
                    .show();
            },
            complete: function() {
                submitBtn.text(originalText).prop('disabled', false);
            }
        });
    });

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    $('#id_username').on('blur', function() {
        var username = $(this).val();
        if (username.length > 0) {
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞:', username);
            $.ajax({
                type: 'GET',
                url: '{% url "register" %}',
                data: {
                    'check_username': username
                },
                success: function(response) {
                    console.log('–û—Ç–≤–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–Ω–∞:', response);
                    if (response.exists) {
                        $('#username-error').text('–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–Ω–∞:', error);
                }
            });
        }
    });

    $('#id_email').on('blur', function() {
        var email = $(this).val();
        if (email.length > 0) {
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ email:', email);
            $.ajax({
                type: 'GET',
                url: '{% url "register" %}',
                data: {
                    'check_email': email
                },
                success: function(response) {
                    console.log('–û—Ç–≤–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ email:', response);
                    if (response.exists) {
                        $('#email-error').text('–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ email:', error);
                }
            });
        }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CAPTCHA
    function refreshCaptcha() {
        console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CAPTCHA');
        $.ajax({
            type: 'GET',
            url: '{% url "register" %}',
            data: {
                'refresh_captcha': true
            },
            success: function(response) {
                console.log('–ù–æ–≤–∞—è CAPTCHA:', response);
                if (response.captcha_text) {
                    $('#captcha-text').text(response.captcha_text);
                    $('#id_captcha').val('');
                } else {
                    console.log('‚ùå –ù–µ—Ç captcha_text –≤ –æ—Ç–≤–µ—Ç–µ');
                }
            },
            error: function(xhr, status, error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CAPTCHA:', error);
                console.log('–°—Ç–∞—Ç—É—Å:', status);
                console.log('–û—Ç–≤–µ—Ç:', xhr.responseText);
            }
        });
    }

    // –ö–ª–∏–∫ –ø–æ CAPTCHA –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    $('#captcha-text').on('click', function() {
        refreshCaptcha();
    });

    // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
    $('input, select, textarea').on('input', function() {
        var fieldName = $(this).attr('name');
        $('#' + fieldName + '-error').text('');
    });
});
</script>

<style>
.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
    padding: 12px;
    border-radius: 4px;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 12px;
    border-radius: 4px;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
}

.form-control {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.75rem;
    font-size: 1rem;
    width: 100%;
    box-sizing: border-box;
}

.form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    outline: none;
}

.btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
}

.btn:hover {
    background: #2980b9;
}

.btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
}

.error {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: block;
}
</style>
{% endblock %}